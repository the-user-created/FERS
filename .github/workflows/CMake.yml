name: C++ Build on Linux

on:
  push:

jobs:
  build:
    runs-on: self-hosted  # Use a self-hosted runner
    container:
      image: ubuntu:latest  # Use the latest Ubuntu container image

    steps:
      - name: Checkout project
        uses: actions/checkout@v4  # Checkout the repository

      - name: Set up environment  # Update package lists and install required packages
        run: |
          apt-get update && apt-get install -y \
          libhdf5-dev \
          libhdf5-serial-dev \
          build-essential \
          cmake \
          cmake-qt-gui \
          libtinyxml-dev \
          libxerces-c-dev \
          lsb-release

      - name: Set up Python  # Install Python 3.11, pip, and venv
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies in virtual environment  # Create venv and install dependencies
        run: |
          python3 -m venv venv
          . venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate and Build FERS
        run: |
          mkdir -p build
          cd build
          . ../venv/bin/activate
          cmake -S .. -B . \
            -D Python_EXECUTABLE=$(which python3) \
            -D CMAKE_BUILD_TYPE=Release \
            -D FERS_LIB_HDF5="/usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5.so" \
            -D FERS_LIB_HDF5_HL="/usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5_hl.so" \
            -D CMAKE_CXX_FLAGS="-I/usr/include/hdf5/serial/"
          make -j$(nproc)

      - name: Run tests # Run the simulation tests
        run: |
          set -e
          . venv/bin/activate
          python3 run_sim_tests.py
          echo "Exit code: $?"

      - name: Generate and Build Validator
        working-directory: config_validators  # Set working directory to config_validators
        run: |
          mkdir -p build
          cd build
          cmake ..
          make -j$(nproc)